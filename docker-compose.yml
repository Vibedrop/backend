services:
  backend:
    image: registry.chasacademy.dev/chas-challenge-2025/vibedrop/backend:${DOCKER_TAG}
    restart: always
    networks:
        - traefik-public
        - internal-only
    environment:
        - NODE_ENV=production
        - DATABASE_URL=${DATABASE_URL}
        - S3_BUCKET_NAME=vibedrop
        - S3_REGION=us-east-1
        - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
        - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
        - S3_ENDPOINT=http://vibedrop-localstack:4566
    deploy:
        mode: replicated
        replicas: 1
        labels:
            - traefik.enable=true
            - traefik.docker.network=traefik-public
            - traefik.constraint-label=traefik-public
            - traefik.http.routers.${NORMALIZED_STACK_NAME}-http.rule=Host(`${CI_ENVIRONMENT_SLUG}.cc25.chasacademy.dev`)
            - traefik.http.routers.${NORMALIZED_STACK_NAME}-http.entrypoints=http
            - traefik.http.routers.${NORMALIZED_STACK_NAME}-http.middlewares=https-redirect
            - traefik.http.routers.${NORMALIZED_STACK_NAME}-https.rule=Host(`${CI_ENVIRONMENT_SLUG}.cc25.chasacademy.dev`)
            - traefik.http.routers.${NORMALIZED_STACK_NAME}-https.entrypoints=https
            - traefik.http.routers.${NORMALIZED_STACK_NAME}-https.tls=true
            - traefik.http.routers.${NORMALIZED_STACK_NAME}-https.tls.certresolver=le
            - traefik.http.routers.${NORMALIZED_STACK_NAME}.tls.domains[0].main=cc25.chasacademy.dev
            - traefik.http.routers.${NORMALIZED_STACK_NAME}.tls.domains[0].sans=*.cc25.chasacademy.dev            
            - traefik.http.services.${NORMALIZED_STACK_NAME}.loadbalancer.server.port=3000

networks:
    traefik-public:
        external: true
    internal-only:
    external: true
